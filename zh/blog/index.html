<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="KubeVela Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="KubeVela Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5GLR1Y52M7"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5GLR1Y52M7",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="KubeVela" href="/zh/opensearch.xml"><title data-react-helmet="true">Blog | KubeVela</title><meta data-react-helmet="true" property="og:title" content="Blog | KubeVela"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://kubevela.io/zh/blog"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" property="og:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kubevela.io/zh/blog"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/zh/blog" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.e219f265.css">
<link rel="preload" href="/zh/assets/js/runtime~main.013ba7d0.js" as="script">
<link rel="preload" href="/zh/assets/js/main.5874ed7f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a><a class="navbar__item navbar__link" href="/zh/docs/">文档</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">博客</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs/">v1.1</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/">Next</a></li><li><a class="dropdown__link" href="/zh/docs/">v1.1</a></li><li><a class="dropdown__link" href="/zh/docs/v1.0/">v1.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></div><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh/docs/next/">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/">v1.1</a></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/v1.0/">v1.0</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/zh/docs/">文档</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/zh/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">简体中文</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2021/09/02/kubevela-jenkins-cicd">使用 Jenkins + KubeVela 完成应用的持续交付</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2021/08/30/kubevela-performance-test">KubeVela Performance Test - Managing Massive Applications</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/zh/blog/2020/12/07/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela 正式开源：一个高可扩展的云原生应用平台与核心引擎</a></li></ul></div></div><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/zh/blog/2021/09/02/kubevela-jenkins-cicd">使用 Jenkins + KubeVela 完成应用的持续交付</a></h2><div class="margin-vert--md"><time datetime="2021-09-02T00:00:00.000Z" class="blogPostDate_fNvV">2021年9月2日 · 阅读需要 1 分钟</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song</a></h4><small class="avatar__subtitle">KubeVela 团队</small></div></div></header><div class="markdown"><p>KubeVela 打通了应用与基础设施之间的交付管控的壁垒，相较于原生的 Kubernetes 对象，KubeVela 的 Application 更好地简化抽象了开发者需要关心的配置，将复杂的基础设施能力及编排细节留给了平台工程师。而 KubeVela 的 apiserver 则是进一步为开发者提供了使用 HTTP Request 直接操纵 Application 的途径，使得开发者即使没有 Kubernetes 的使用经验与集群访问权限也可以轻松部署自己的应用。</p><p>本文就以经典的持续集成 (Continuous Integration) 工具 Jenkins 为基础，简单介绍如何打造基于 GitOps 的应用持续交付的“高速公路”。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="持续交付高速公路"></a>持续交付“高速公路”<a class="hash-link" href="#持续交付高速公路" title="Direct link to heading">#</a></h2><p>作为应用开发者的你，更多地关心自己的应用是否正常运作，开发流程是否便捷高效。为此，在这条持续交付的“高速公路”上，将会由以下部件为你保驾护航。</p><ol><li>你需要一个 git 仓库来存放应用程序代码、测试代码，以及描述 KubeVela Application 的 YAML 文件。</li><li>你需要一个持续集成 (Continuous Integration) 的工具帮你自动化完成程序代码的测试，并打包成镜像上传到仓库中。</li><li>你需要在 Kubernetes 集群上安装 KubeVela 并启用 apiserver 功能。</li></ol><blockquote><p>目前 KubeVela 的 apiserver 在权限认证方面仍待完善，后续启用 apiserver 后将会加入权限配置环节。</p></blockquote><p>本文的介绍中采用了 Github 作为 git 仓库，Jenkins 作为 CI 工具，DockerHub 作为镜像仓库。应用程序以一个简单的 HTTP Server 为例，整个持续交付的流程如下。可以看到，在这条持续交付的“高速公路”上，开发者只需要关心应用的开发并使用 Git 进行代码版本的维护，即可自动走完测试流程并部署应用到 Kubernetes 集群中。</p><p><img alt="arch" src="/zh/assets/images/arch-53b2b1a473f0d637d4c7c0b9a81dd2b0.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="部署环境"></a>部署环境<a class="hash-link" href="#部署环境" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="jenkins-环境"></a>Jenkins 环境<a class="hash-link" href="#jenkins-环境" title="Direct link to heading">#</a></h3><blockquote><p>本文采用了 Jenkins 作为持续集成工具，开发者也可以使用其他 CI 工具，如 TravisCI 或者 GitHub Action。</p></blockquote><p>首先你需要准备一份 Jenkins 环境来部署 CI 流水线。安装与初始化 Jenkins 流程可以参见<a href="https://www.jenkins.io/doc/book/installing/linux/" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><p>需要注意的是，由于本文的 CI 流水线是基于 Docker 及 GitHub 的，因此在安装 Jenkins 之后还需要安装相关插件 (Dashboard &gt; Manage Jenkins &gt; Manage Plugins) ，包括 Pipeline、HTTP Request Plugin、Docker Pipeline、Docker Plugin。</p><p>此外，还需要为 Jenkins 配置 Docker 的运行环境 (Dashboard &gt; Manage Jenkins &gt; Configure System &gt; Docker Builder) ，如 Jenkins 所在环境已经安装了 Docker，可以将 Docker URL 配置为 <code>unix:///var/run/docker.sock</code>。</p><p>由于在 CI 流水线运行过程中，还需要将容器镜像推至镜像仓库，为此需在 Jenkins 的 Credential 中将镜像仓库的账户配置好 (Dashboard &gt; Manage Jenkins &gt; Manage Credentials &gt; Add Credentials) ，比如将 DockerHub 的用户名及密码存入。</p><p><img alt="jenkins-credential" src="/zh/assets/images/jenkins-credential-52c71b3f3a886ec0596a29a2356ad291.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="github-仓库环境"></a>GitHub 仓库环境<a class="hash-link" href="#github-仓库环境" title="Direct link to heading">#</a></h3><blockquote><p>本文的介绍采用了 Github 作为代码仓库，开发者还可以根据各自的需求与喜好，使用其他代码仓库，如 Gitlab。</p></blockquote><p>为使持续集成工具 Jenkins 能够获取到 GitHub 中的更新，并将流水线的运行状态反馈回 GitHub，需要在 GitHub 中完成以下两步操作。</p><ol><li><a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">配置</a> Personal Access Token。注意将 <code>repo:status</code> 勾选，以获得向 GitHub 推送 Commit 状态的权限。</li></ol><p><img alt="github-pat" src="/zh/assets/images/github-pat-a8de5950eaf01a6d416a869d70b189ac.png"></p><p>然后在 Jenkins 的 Credential 中加入 Secret Text 类型的 Credential 并将上述的 GitHub 的 Personal Access Token 填入。</p><p><img alt="jenkins-secret-text" src="/zh/assets/images/jenkins-secret-text-0de6c324500b26a5bfb81520ff7eab2b.png"></p><p>最后来到 Jenkins 的 Dashboard &gt; Manage Jenkins &gt; Configure System &gt; GitHub 中点击 Add GitHub Server 并将刚才创建的 Credential 填入。完成后可以点击 Test connection 来验证配置是否正确。</p><p><img alt="jenkins-github" src="/zh/assets/images/jenkins-github-e99c47fab606f6c9c9f3f6f841840329.png"></p><ol start="2"><li>在 GitHub 的代码仓库的设定里添加 Webhook，将 Jenkins 的地址对应的 Webhook 地址填入，比如 <a href="http://my-jenkins.example.com/github-webhook/" target="_blank" rel="noopener noreferrer">http://my-jenkins.example.com/github-webhook/</a> 。这样，该代码仓库的所有 Push 事件推送到 Jenkins 中。</li></ol><p><img alt="github-webhook" src="/zh/assets/images/github-webhook-5579402b6bc37238d42842fd5d52fd02.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-环境"></a>KubeVela 环境<a class="hash-link" href="#kubevela-环境" title="Direct link to heading">#</a></h3><p>你需要在 Kubernetes 集群中安装 KubeVela，并启用 apiserver 功能，可以参考<a href="/zh/docs/platform-engineers/advanced-install#install-kubevela-with-apiserver">官方文档</a>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="编写应用"></a>编写应用<a class="hash-link" href="#编写应用" title="Direct link to heading">#</a></h2><p>本文采用的应用是一个基于 Golang 语言编写的简单的 HTTP Server。在代码中，声明了一个名叫 <code>VERSION</code> 的常量，并在访问该服务时打印出来。同时还附带一个简单的测试，用来校验 <code>VERSION</code> 的格式是否符合标准。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;fmt&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;net/http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.1.0-v1alpha1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandleFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Version: %s\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ListenAndServe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;:8088&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">println</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main_test.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;regexp&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;testing&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> verRegex </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`^v?([0-9]+)(\.[0-9]+)?(\.[0-9]+)?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(-([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(\+([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?$`</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">TestVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t </span><span class="token operator">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> ok</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> regexp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">MatchString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">verRegex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fatalf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid version: %s&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在应用交付时需要将 Golang 服务打包成镜像并以 KubeVela Application 的形式发布到 Kubernetes 集群中，因此在代码仓库中还包含 <code>Dockerfile</code> 以及 <code>app.yaml</code> 文件，分别用来描述镜像的打包方式以及 Application 的相关配置。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Dockerfile"><div tabindex="0" class="prism-code language-Dockerfile codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"># Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM golang:1.13-rc-alpine3.10 as builder</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY main.go .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">RUN go build -o kubevela-demo-cicd-app main.go</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM alpine:3.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY --from=builder /app/kubevela-demo-cicd-app /app/kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT ./kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE 8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 app.yaml 中，声明了部署的应用包含 5 个不同副本，同时通过 Ingress 的形式发布给集群外部。而 labels 则是给应用中的 Pod 打上了当前的 git commit 作为标签。当 Jenkins 的部署流水线运行时，会将 GIT_COMMIT 注入其中，提交到 KubeVela apiserver，从而触发 Application 的更新。在版本更新过程中，按照 2, 3 的数量分两次次更新副本，同时在第一次更新后停止自动更新，等待手动确认后再进行全部更新，实现金丝雀发布的过程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># app.yaml</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">web</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> somefive/kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Always</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rolloutBatches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">batchPartition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> labels</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">jenkins-build-commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app.cf7c0ed25b151437ebe1ef58efc29bca4.us</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">west</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.alicontainer.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="配置-ci-流水线"></a>配置 CI 流水线<a class="hash-link" href="#配置-ci-流水线" title="Direct link to heading">#</a></h2><p>在本文的案例中，包含两条流水线，一条是用来进行测试的流水线 (对应用代码运行测试) ，一条是交付流水线 (将应用代码打包上传镜像仓库，同时更新目标环境中的应用，实现自动更新) 。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="测试流水线"></a>测试流水线<a class="hash-link" href="#测试流水线" title="Direct link to heading">#</a></h3><p>在 Jenkins 中创建一条新的 Pipeline，并配置 Build Triggers 为 GitHub hook trigger for GITScm polling。</p><p><img alt="test-pipeline-create" src="/zh/assets/images/test-pipeline-create-34edf7a7b95307cec884803ca545c2e3.png">
<img alt="test-pipeline-config" src="/zh/assets/images/test-pipeline-config-3ae2830ca7d45dbe9579a7814d96abc0.png"></p><p>在这条流水线中，首先是采用了 golang 的镜像作为执行环境，方便后续运行测试。然后将分支配置为 GitHub 仓库中的 dev 分支，代表该条流水线被 Push 事件触发后会拉取 dev 分支上的内容并执行测试。测试结束后将流水线的状态回写至 GitHub 中。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/test-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        docker { image &#x27;golang:1.13-rc-alpine3.10&#x27; }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;dev&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                setBuildStatus(&quot;Test running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Test&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;CGO_ENABLED=0 GOCACHE=$(pwd)/.cache go test *.go&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="部署流水线"></a>部署流水线<a class="hash-link" href="#部署流水线" title="Direct link to heading">#</a></h3><p>在部署流水线中，类似测试流水线，首先将代码仓库中的分支拉取下来，区别是这里采用 prod 分支。然后使用 Docker 进行镜像构建并推送至远端镜像仓库 (这里为 DockerHub，其中 withRegistry 中填写镜像仓库位置以及在先前步骤中存入的 DockerHub 的账户对应的 Credential 的 ID) 。构建成功后，再将 Application 对应的 YAML 文件转换为 JSON 文件并注入 GIT_COMMIT，最后向 KubeVela apiserver (此处为 <a href="http://47.88.24.19/" target="_blank" rel="noopener noreferrer">http://47.88.24.19/</a>) 发送请求进行创建或更新。</p><blockquote><p>目前的 KubeVela apiserver 接收 JSON 参数，因此在流水线中做了相应的转换。未来的 KubeVela apiserver 将会进一步改进交互模式，简化此处的流程，同时再加上更为严格的权限认证，提高安全性。</p></blockquote><blockquote><p>该案例中会向 kubevela-demo-namespace 这个 Namespace 中创建名叫 cicd-demo-app 的应用，注意这个 Namespace 需要预先在 Kubernetes 中创建出来。未来 KubeVela 的 apiserver 同样会简化这一流程。</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/deploy-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent any</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;prod&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    setBuildStatus(&quot;Deploy running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Build&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    docker.withRegistry(&quot;https://registry.hub.docker.com&quot;, &quot;DockerHubCredential&quot;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        def customImage = docker.build(&quot;somefive/kubevela-demo-cicd-app&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        customImage.push()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Deploy&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;wget -q &quot;https://github.com/mikefarah/yq/releases/download/v4.12.1/yq_linux_amd64&quot;&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;chmod +x yq_linux_amd64&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def app = sh (</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        script: &quot;./yq_linux_amd64 eval -o=json &#x27;.spec&#x27; app.yaml | sed -e &#x27;s/GIT_COMMIT/$GIT_COMMIT/g&#x27;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        returnStdout: true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    )</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;app: ${app}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def response = httpRequest acceptType: &#x27;APPLICATION_JSON&#x27;, contentType: &#x27;APPLICATION_JSON&#x27;, httpMode: &#x27;POST&#x27;, requestBody: app, url: &quot;http://47.88.24.19/v1/namespaces/kubevela-demo-namespace/applications/cicd-demo-app&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Status: &#x27;+response.status)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Response: &#x27;+response.content)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="实际表现"></a>实际表现<a class="hash-link" href="#实际表现" title="Direct link to heading">#</a></h2><p>在完成上述的配置流程后，持续交付的流程便已经搭建完成。我们可以来检验一下它的效果。</p><p><img alt="pipeline-overview" src="/zh/assets/images/pipeline-overview-36827d3925d667b9d14612cb59e8fb4e.png"></p><p>我们首先将 <code>main.go</code> 中的 <code>VERSION</code> 字段修改为 <code>Bad Version Number</code>，即</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Bad Version Number&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>然后提交该修改至 dev 分支。我们可以看到 Jenkins 上的测试流水线被触发运行，失败后将该状态回写给 GitHub。</p><p><img alt="test-pipeline-fail" src="/zh/assets/images/test-pipeline-fail-23682b9d0c60a43f26be0a5a98e8a413.png">
<img alt="test-github-fail" src="/zh/assets/images/test-github-fail-5dd21696c58a212cf6ca2ee80e56567e.png"></p><p>我们重新将 <code>VERSION</code> 修改为 0.1.1，然后再次提交。可以看到这一次测试流水线成功完成执行，并在 GitHub 对应的 Commit 上看到了成功的标志。</p><p><img alt="test-pipeline-success" src="/zh/assets/images/test-pipeline-success-cd84def7976efb35b5071c9e361d2a77.png">
<img alt="test-github-success" src="/zh/assets/images/test-github-success-1d9c59d67bfd9b24d8b455fa21c6d985.png"></p><p>接下来我们在 GitHub 上提交 Pull Request 尝试将 dev 分支上的更新合并至 prod 分支上。</p><p><img alt="pull-request" src="/zh/assets/images/pull-request-eca7ff259bb26a6661d79691728b0b31.png"></p><p>可以看到在 Jenkins 的部署流水线成功运行结束后，GitHub 上 prod 分支最新的 Commit 也显示了成功的标志。</p><p><img alt="deploy-pipeline-success" src="/zh/assets/images/deploy-pipeline-success-7890c92b41e666ef46f3bd2dc1975ee7.png">
<img alt="deploy-github-success" src="/zh/assets/images/deploy-github-success-07f305b1b587e3fa8acc5df68fd8c297.png"></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                     COMPONENT               TYPE         PHASE     HEALTHY   STATUS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-cicd-app   kubevela-demo-app-web   webservice   running   </span><span class="token boolean">true</span><span class="token plain">               112s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2m1s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>如图显示，要部署的应用顺利被 KubeVela apiserver 接受并由 KubeVela 控制器创建了相关资源。当前 Deployment 的副本数是 2，在删除了该 Application 中 rollout 特征内的 <code>batchPartition: 0</code> 后代表确认了当前的发布，然后对应的 Deployment 副本数更新至 5。这时我们可以访问 Ingress 所配置的域名，成功显示了当前的版本号。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl edit app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">application.core.oam.dev/kubevela-demo-cicd-app edited</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>我们重复以上步骤，将版本升级至 0.1.2，完成测试流水线及部署流水线。接着我们会发现 Kubernetes 的集群内对应的 Application 控制的 Deployment 发生了版本更替，旧版本的 Deployment 从 5 副本下降到 3 副本，新版本的 Deployment 则出现了 2 副本。如果此时我们再访问原来的服务地址，会发现有时会显示 0.1.1 版本，有时会显示 0.1.2 版本。这是因为在当前滚动更新过程中，新旧副本同时存在，访问的流量会被负载均衡器分发到不同的副本上，因此会出现两种版本的服务同时存在的现象。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           11m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">1</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">1</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           13m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>当我们确认新版本的服务正常运作后，可以类似上述步骤，将 Application 中 rollout 特性内的 <code>batchPartition: 0</code> 删去，完成整个金丝雀发布流程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m24s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m36s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">3</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="小结"></a>小结<a class="hash-link" href="#小结" title="Direct link to heading">#</a></h2><p>至此，我们便已经成功实现了一整套持续交付流程。在这个流程中，应用的开发者借助 KubeVela + Jenkins 的能力，可以轻松完成应用的迭代更新、集成测试、自动发布与滚动升级，而整个流程在各个环节也可以按照开发者的喜好和条件选择不同的工具，比如使用 Gitlab 替代 GitHub，或是使用 TravisCI 替代 Jenkins。</p><p>在上述过程中，细心的读者可能还会发现，这套流程不仅能够实现应用服务的升级，而且还可以通过修改 app.yaml 自动完成部署方案的升级，比如将 5 副本应用扩容到 10 副本，或是为容器添加 sidecar，从而实现部分 GitOps 能力。关于使用 KubeVela 实践 GitOps 的更多内容，感兴趣的读者可以继续阅读相关案例。</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/zh/blog/tags/kubevela">kubevela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/zh/blog/2021/08/30/kubevela-performance-test">KubeVela Performance Test - Managing Massive Applications</a></h2><div class="margin-vert--md"><time datetime="2021-08-30T00:00:00.000Z" class="blogPostDate_fNvV">2021年8月30日 · 阅读需要 1 分钟</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song, Zhengxi Zhou and Jianbo Sun"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song, Zhengxi Zhou and Jianbo Sun</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>As an application management and integration platform, KubeVela needs to handle thousands of applications in production scenario. To evaluate the performance of KubeVela, develop team has conducted performance tests based on simultated environments and demonstrated the capability of managing a large number of applications concurrently.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cluster-environment"></a>Cluster Environment<a class="hash-link" href="#cluster-environment" title="Direct link to heading">#</a></h3><p>Working with large clusters requires lots of resources, such as Machines, Network Bandwidth, Storages and many other devices. Therefore, KubeVela team adopts kubemark, an official tool provided by kubernetes, to simulate large clusters by mocking hundreds of kubelets. Each kubelet works like a real node except that they do not run real containers inside pods. The aim of KubeVela performance test mainly focus on whether KubeVela controller can manage thousands of applications effectively, instead of pulling images or executing commands inside pods. As a result, we only need to get resources hosting these fake nodes, also named as hollow-nodes.</p><p>We set up the Kubernetes clusters on Alibaba Cloud which includes 5 master nodes and 15 worker nodes. The master nodes wil host Kubernetes core components such as kube-apiserver and kube-controller-manager. The worker nodes need to run other pressure-test related componets, including monitoring tools, KubeVela controller and kubemark pods. Since the major target is to test the performance of KubeVela controller, we do not expect other components to be the bottleneck of the pressure test. To this end, both master nodes and worker nodes are equiped with 32 cores and 128 Gi memory. We use the combination of Prometheus, Loki and Grafana as the monitoring suites and grant them enough resources in avoid of crash caused by Out-of-Memory.</p><p>Notice that KubeVela controller and monitoring tools need to be placed on real nodes to function while all pods created during performance tests should be assigned to hollow-nodes correctly. To achieve that, we give different taints to hollow-nodes and real nodes, and add corresponding tolerations to different pods.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="application"></a>Application<a class="hash-link" href="#application" title="Direct link to heading">#</a></h3><p>To simulate real applications in production, we design an application template with 2 components and 5 functional traits, including</p><ul><li>1 webservice component<ul><li>a scaler trait setting its replica to 3</li><li>a sidecar trait attaching another container to each pod</li><li>an ingress trait generating one ingress instance and one service instance</li></ul></li><li>1 worker component<ul><li>a scaler trait also setting its replica to 3</li><li>a configmap trait generating a new configmap and attaching it to worker pods</li></ul></li></ul><p>In the following experiment, we test the performance of KubeVela controller managing 3,000 Applications (12,000 Pods in total) on 200 nodes. Applications are created in parallel at first, then kept running for a while, and finally deleted from the cluster. Each application will be reconciled multiple times with latencies and consumed resources recorded by monitoring tools.</p><blockquote><p>In practice, we also have another trait used for adding tolerations as described above.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-controller"></a>KubeVela Controller<a class="hash-link" href="#kubevela-controller" title="Direct link to heading">#</a></h3><p>The KubeVela controller is set up with a group of recommendation configurations as follows</p><ul><li>Kubernetes Resource<ul><li>0.5 core CPU</li><li>1 Gi Memory</li><li>1 replica</li></ul></li><li>Program <ul><li>concurrent-reconciles=2 (The number of reconcile threads)</li><li>kube-api-qps=300 (The qps of kubernetes client used in controller)</li><li>kube-api-burst=500 (The burst of kubernetes client used in controller)</li><li>informer-re-sync-interval=20m (The interval of routine reconciles.)
We will analyze these settings in the below sections.</li></ul></li></ul><blockquote><p>To evaluate the performance of KubeVela Controller itself, we disabled the Ingress MutatingWebhook and Application ValidatingWebhook which is beyond the focus of this test but will affect the performance of KubeVela Controller by increasing the latency of creating/patching resources.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="experiments"></a>Experiments<a class="hash-link" href="#experiments" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creation"></a>Creation<a class="hash-link" href="#creation" title="Direct link to heading">#</a></h3><p>The creation of all 3,000 applications lasted 25min. Getting all pods running takes a bit longer time, which is out of the scope of KubeVela controller. </p><p>For each application creation, it will trigger three turns of reconciling. The usage of CPU will reach 100% in the late period of creation. The memory usage will increase as the number of applications rises. It reaches around 67% at the end of creation.</p><p><img alt="create-cpu" src="/zh/assets/images/create-cpu-50a2f951ca18219c47f86fc87861387a.png">
<img alt="create-memory" src="/zh/assets/images/create-memory-1d5a108aa88dca5b5233df07b975869f.png"></p><p>The average time of the first turn reconciling is relatively short since it only needs patch finalizer. The second and third turn reconciling contain full reconcile cycles and need more time to process. The following charts record the time consumptions of different period during reconciling applications. The average time is generally below 200ms while 99% of reconciles uses less than 800ms.</p><p><img alt="create-avg-time" src="/zh/assets/images/create-avg-time-c9096f848bacebb15879e354db90ad79.png">
<img alt="create-p99-time" src="/zh/assets/images/create-p99-time-6834848739195ef1a6836e8830a60940.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="regular-reconciles"></a>Regular Reconciles<a class="hash-link" href="#regular-reconciles" title="Direct link to heading">#</a></h3><p>After creation, applications are reconciled by controller every 20min. the monitoring of 8-hour reconcile process are displayed as below. The CPU usage will come up to 90% once reconcile happens routinely. The memory usage generally keeps a stable pattern, up to 75% memory usage.</p><p><img alt="med-cpu" src="/zh/assets/images/med-cpu-1ee6beebe2ddac70499b2fe0f1200346.png">
<img alt="med-memory" src="/zh/assets/images/med-memory-84ee70599fdfe10c539d31a8ffd011f3.png"></p><p>The average reconcile time is under 200ms while 99% are about 800ms~900ms. Each regular reconcile for all applications generally takes around 10min.</p><p><img alt="med-avg" src="/zh/assets/images/med-avg-71e81f42a57ba18fe977c1cb8f041e6f.png">
<img alt="med-p99" src="/zh/assets/images/med-p99-660473173a37679faf8f5c54a4668b7c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deletion"></a>Deletion<a class="hash-link" href="#deletion" title="Direct link to heading">#</a></h3><p>The application deletion process is fast and low-resource consumptive. It takes less than 3min to delete all applications. However, notice that the deletion of resources managed by application usually takes longer time. This is because the cleanup of these resources (such as deployments or pods) are not directly controlled by the KubeVela controller. KubeVela controller takes charge of deleting their owner and cleanup them by triggering cascading deletion. In addition, each deletion is associated with two turns of reconcile where the second turn returns immediately when it fails to retrieve target applciation (since it is deleted).</p><p><img alt="del-cpu" src="/zh/assets/images/del-cpu-e20c033c8d55123b17d4daf25af8b0e1.png">
<img alt="del-memory" src="/zh/assets/images/del-memory-7185fe1f634f7bfede12924608db96f2.png">
<img alt="del-avg" src="/zh/assets/images/del-avg-b8c9b19de6d6472f5ad751ee5b13cd22.png">
<img alt="del-p99" src="/zh/assets/images/del-p99-c2efbbd508a210d006bbb511944ec547.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="analysis"></a>Analysis<a class="hash-link" href="#analysis" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="number-of-applications"></a>Number of Applications<a class="hash-link" href="#number-of-applications" title="Direct link to heading">#</a></h3><p>The experiment displayed above demonstrates a classical scenario for KubeVela. Although 3,000 applications are successfully managed by the KubeVela controller in this case, it is strongly recommended to adopt a smaller number (such as 2,000) of applications with the above configuration for the following reasons:
The time and resource consumption is closely associated with the spec of applications. If a lot of users apply larger applications with more pods and more other resources, 3,000 applications might break the resource limit more easily.
The memory and CPU usage shown above is approching resource limits. If memory drains, the KubeVela controller will crash and restart. If high CPU usage maintains for a long time, it might cause a long waiting queue in KubeVela controller which further lead to longer response time for application changes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="configurations"></a>Configurations<a class="hash-link" href="#configurations" title="Direct link to heading">#</a></h3><p>There are several parameters users could config to adapt into their own scenario.
Using more replica for KubeVela controller do not scale up the ability of KubeVela controller. The leader election mechanism ensures that only one replica will work while others will wait. The aim of multi-replica is to support fast recovery when the working one crash. However, if the crash is caused by OOM, the recovery usually will not be able to fix that.
The number of qps and burst in the program configuration should be increased accordingly while scaling up KubeVela controller. These two parameters limit the capability for controller to send requests to apiserver.
Generally, in order to scale up KubeVela controller, scale up the resource limits and all the program parameters mentioned above (except the reconcile interval). If you have more applications to manage, add more memory. If you have higher operation frequency, add more CPU and threads, then increase qps and burst accordingly.
Longer reconcile interval allows more applications to handle, at the cost of longer time to fix potential underlying resource problems. For example, if one deployment managed by one application disappears, the routine reconciling can discover this problem and fix it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="scaling-up"></a>Scaling Up<a class="hash-link" href="#scaling-up" title="Direct link to heading">#</a></h3><p>In addition to the experiment described above, we conducted another two experiment to test how well KubeVela controller can scale to larger clusters and more applications.</p><p>In a 500-node cluster, we tried to create 5,000 applications with the same spec described above, at the speed of 4 per second and lasted for around 21min. 1 core and 2 Gi memory are granted to KubeVela controller with the use of 4 concurrent reconcile threads. The kube-api-qps and kube-api-burst are raised to 500/800 correspondingly. All 30,000 pods successfully turn into Running phase. The time costs for each reconcile is similar to the previous experiment and CPU/Memory cost is not very high compared to the given resources. The regular reconciles for 5,000 applications takes 7~8 minutes, and no significant resource cost is observed. During this scaling, we found that the throughput of kube-apiserver starts to block the creation of application, as too many resources need to be created while applying applications.</p><p><img alt="std-cpu" src="/zh/assets/images/std-cpu-ffd81b9aa9f3f19744fe28d7f9817e73.png">
<img alt="std-memory" src="/zh/assets/images/std-memory-d0fb9771e7ab4d9588ef193424a76073.png"></p><p>Scaling up to 12,000 applications on 1,000 nodes is much harder than previous attempts. With the same creation speed, the apiserver will be flooded by lots of pod scheduling requests and finally start to drop application creation request. To overcome this difficulty, we divide the creation process of applications into several stage. Each stage only create 1,000~3,000 applications and the next stage will not begin until all pods are ready. With this strategy, we successfully create 12,000 applications, 24,000 deployments, 12,000 services, 12,000 ingress, 12,000 configmaps and 72,000 pods. The whole process takes about 30 hours. To hold this number of applications, KubeVela controller consumes 1.7 cores and 2.45 Gi memory. It takes about 12min to finish a full turn of regular reconciles for all 12,000 applications.</p><p><img alt="large-cpu" src="/zh/assets/images/large-cpu-d83276edbb15f8a396f27ea144625469.png">
<img alt="large-memory" src="/zh/assets/images/large-memory-360f435a8446f13a86246c19fad2f729.png">
<img alt="large-all" src="/zh/assets/images/large-all-8b83d8c79d4faf56ba67aa9594ce5eee.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="future"></a>Future<a class="hash-link" href="#future" title="Direct link to heading">#</a></h3><p>The performance test of KubeVela demonstrates its ability of managing thousands of applications with limited resource consumption. It can also scale up to over 10,000 applications on large clusters with 1,000 nodes. In addition, KubeVela team also conducted similar pressure test for non-deployment based applications such as CloneSet in OpenKruise (which is not enclosed in this report) and reach same conclusions. In the future, we will add more performance tests for more complex scenario like Workflow or MultiCluster.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/zh/blog/tags/kubevela">kubevela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/zh/blog/2020/12/07/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela 正式开源：一个高可扩展的云原生应用平台与核心引擎</a></h2><div class="margin-vert--md"><time datetime="2020-12-07T00:00:00.000Z" class="blogPostDate_fNvV">2020年12月7日 · 阅读需要 1 分钟</time></div><div class="avatar margin-vert--md"><a href="https://github.com/resouer" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/1701782?s=200&amp;v=4" alt="Lei Zhang and Fei Guo"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/resouer" target="_blank" rel="noopener noreferrer">Lei Zhang and Fei Guo</a></h4><small class="avatar__subtitle">CNCF TOC Member/Kubernetes</small></div></div></header><div class="markdown"><blockquote><p>2020年12月7日 12:33, by Lei Zhang and Fei Guo</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg" alt="image"></p><p>美国西部时间 2020 年 11 月 18 日，在云原生技术“最高盛宴”的 KubeCon 北美峰会 2020 上，CNCF 应用交付领域小组（CNCF SIG App Delivery) 与 Open Application Model (OAM) 社区，以及来自阿里云、微软云的 OAM 项目维护者们在演讲中共同宣布了 KubeVela 开源项目的正式发布。</p><p>从 11 月 18 号到 20 号，在为期三天的 KubeCon 北美峰会上有连续 3 场技术演讲，会从不同维度介绍关于 KubeVela 项目的具体细节，其中还包括一个长达 1 个半小时的 KubeVela 互动教学环节。多个重量级组织以如此规模和密度在 KubeCon 北美峰会演讲中介绍一个首次发布的社区开源项目，在 KubeCon 诞生以来并不多见。</p><p>KubeVela Github 地址：<a href="https://github.com/oam-dev/kubevela/" target="_blank" rel="noopener noreferrer">https://github.com/oam-dev/kubevela/</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="什么是-kubevela-？"></a>什么是 KubeVela ？<a class="hash-link" href="#什么是-kubevela-？" title="Direct link to heading">#</a></h2><p>一言以蔽之，<strong>KubeVela 是一个简单易用且高度可扩展的应用管理平台与核心引擎</strong>。KubeVela 是基于 Kubernetes 与 OAM 技术构建的。</p><p>详细的说，对于应用开发人员来讲，KubeVela 是一个非常低心智负担的云原生应用管理平台，核心功能是让开发人员方便快捷地在 Kubernetes 上定义与交付现代微服务应用，无需了解任何 Kubernetes 本身相关的细节。在这一点上，KubeVela 可以被认为是<strong>云原生社区的 Heroku</strong>。</p><p>另一方面，对于平台团队来讲，KubeVela 是一个强大并且高可扩展的云原生应用平台核心引擎。基于这样一个引擎，平台团队可以快速、高效地以 Kubernetes 原生的方式在 KubeVela 中植入任何来自云原生社区的应用管理能力，从而基于 KubeVela 打造出自己需要的云原生平台，比如：云原生数据库 PaaS、云原生 AI 平台、甚至 Serverless 服务。在这一点上，KubeVela 可以被认为是<strong>一个“以应用为中心”的 Kubernetes 发行版</strong>，以 OAM 为核心，让平台团队可以基于 KubeVela 快速打造出属于自己的 PaaS、Serverless 乃至任何面向用户的云原生平台项目。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-解决了什么问题？"></a>KubeVela 解决了什么问题？<a class="hash-link" href="#kubevela-解决了什么问题？" title="Direct link to heading">#</a></h2><p>现如今，云原生技术的迅猛发展可能让很多人都感觉到眼花缭乱，但实际上，这个生态的总体发展趋势和主旋律，是通过 Kubernetes 搭建了一个统一的基础设施抽象层，为平台团队屏蔽掉了“计算”、“网络”、“存储”等过去我们不得不关注的基础设施概念，使得我们能够基于 Kubernetes 方便地构建出任何我们想要的垂直业务系统而无需关心任何基础设施层的细节。这正是 Kubernetes 被称为云计算界的 Linux 以及 “Platform for Platforms” 的根本原因。</p><p>但是，当我们把视角从平台团队提升到垂直业务系统的最终用户（如：应用开发人员）的时候，我们会发现 Kubernetes 这样的定位和设计在解决了平台团队的大问题之后，却也为用户们带来了挑战和困扰。比如，太多的用户都在抱怨 Kubernetes “太复杂了”。究其原因，其实在于 Kubernetes 中的核心概念与体系，如：Pod、sidecar、Service、资源管理、调度算法和 CRD 等等，主要是面向平台团队而非最终用户设计的。缺乏面向用户的设计不仅带来了陡峭的学习曲线，影响了用户的使用体验，拖慢了研发效能，甚至在很多情况下还会引发错误操作乃至生产故障（毕竟不可能每个业务开发人员都是 Kubernetes 专家）。</p><p>这也是为什么在云原生生态中，几乎每一个平台团队都会基于 Kubernetes 构建一个上层平台给用户使用。最简单的也会给 Kubernetes 做一个图形界面，稍微正式一些的则往往会基于 Kubernetes 开发一个类 PaaS 平台来满足自己的需求。理论上讲，在 Kubernetes 生态中各种能力已经非常丰富的今天，开发一个类 PaaS 平台应该是比较容易的。</p><p>然而现实却往往不尽如人意。在大量的社区访谈当中，我们发现在云原生技术极大普及的今天，基于 Kubernetes 构建一个功能完善、用户友好的上层应用平台，依然是中大型公司们的“专利”。这里的原因在于：</p><blockquote><p>Kubernetes 生态本身的能力池固然丰富，但是社区里却并没有一个可扩展的、方便快捷的方式，能够帮助平台团队把这些能力快速“组装”成面向最终用户的功能（Feature）。</p></blockquote><p>这种困境带来的结果，就是尽管大家今天都在基于 Kubernetes 在构建上层应用平台，但这些平台本质上却并不能够与 Kubernetes 生态完全打通，而都变成一个又一个的垂直“烟囱”。</p><p>在开源社区中，这个问题会更加明显。在今天的 Kubernetes 社区中，不乏各种“面向用户”、“面向应用”的 Kubernetes 上层系统。但正如前文所述，这些平台都无一例外的引入了自己的专属上层抽象、用户界面和插件机制。这里最典型的例子包括经典 PaaS 项目比如 Cloud Foundry，也包括各种 Serverless 平台。作为一个公司的平台团队，我们实际上只有两个选择：要么把自己局限在某种垂直的场景中来适配和采纳某个开源上层平台项目；要么就只能自研一个符合自己诉求的上层平台并且造无数个社区中已经存在的“轮子”。</p><p>那么，有没有”第三种选择”能够让平台团队在不造轮子、完全打通 Kubernetes 生态的前提下，轻松的构建面向用户的上层平台呢？</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-如何解决上述问题？"></a>KubeVela 如何解决上述问题？<a class="hash-link" href="#kubevela-如何解决上述问题？" title="Direct link to heading">#</a></h2><p>KubeVela 项目的创立初衷，就是以一个统一的方式同时解决上述最终用户与平台团队所面临的困境。这也是为何在设计中，KubeVela 对最终用户和平台团队这两种群体进行了单独的画像，以满足他们不同的诉求。</p><p>由于 KubeVela 默认的功能集与“Heroku”类似（即：主要面向应用开发人员），所以在下文中，我们会以应用开发人员或者开发者来代替最终用户。但我们很快也会讲到，KubeVela 里的每一个功能，都是一个插件，作为平台团队，你可以轻松地“卸载”它的所有内置能力、然后“安装”自己需要的任何社区能力，让 KubeVela 变成一个完全不一样的系统。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-用户眼中的-kubevela"></a>1. 用户眼中的 KubeVela<a class="hash-link" href="#1-用户眼中的-kubevela" title="Direct link to heading">#</a></h3><p>前面已经提到，对于开发者来说，KubeVela 是一个简单、易用、又高可扩展的云原生应用管理工具，它可以让开发者以极低的心智负担和上手成本在 Kubernetes 上定义与部署应用。而关于整个系统的使用，开发者只需要编写一个 docker-compose 风格应用描述文件 Appfile 即可，不需要接触和学习任何 Kubernetes 层的相关细节。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1）一个-appfile-示例"></a>1）一个 Appfile 示例<a class="hash-link" href="#1）一个-appfile-示例" title="Direct link to heading">#</a></h4><p>在下述例子中，我们会将一个叫做 vela.yaml 的 Appfile 放在你的应用代码目录中（比如应用的 GitHub Repo）。这个 Appfile 定义了如何将这个应用编译成 Docker 镜像，如何将镜像部署到 Kubernetes，如何配置外界访问应用的路由和域名，又如何让 Kubernetes 自动根据 CPU 使用量来水平扩展这个应用。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>只要有了这个 20 行的配置文件，你接下来唯一需要的事情就是 $ vela up，这个应用就会被部署到 Kubernetes 中然后被外界以 <a href="https://example.com/testapp" target="_blank" rel="noopener noreferrer">https://example.com/testapp</a> 的方式访问到。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2）appfile-是如何工作的？"></a>2）Appfile 是如何工作的？<a class="hash-link" href="#2）appfile-是如何工作的？" title="Direct link to heading">#</a></h4><p>在 KubeVela 的 Appfile 背后，有着非常精妙的设计。首先需要指出的就是，<strong>这个 Appfile 是没有固定的 Schema 的</strong>。</p><p>什么意思呢？这个 Appfile 里面你能够填写的每一个字段，都是直接取决于当前平台中有哪些工作负载类型（Workload Types）和应用特征（Traits）是可用的。而熟悉 OAM 的同学都知道，这两个概念，正是 OAM 规范的核心内容，其中：</p><ul><li><p><a href="https://kubevela.io/#/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">工作负载类型（Workload Type）</a>，定义的是底层基础设施如何运行这个应用。在上面的例子中，我们声明：名叫 testapp 的应用会启动一个类型为“在线 Web 服务（Web Service）” 的工作负载，其实例的名字是 express-server。</p></li><li><p><a href="https://kubevela.io/#/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">应用特征（Traits）</a>，则为工作负载实例加上了运维时配置。在上面的例子中，我们定义了一个 Route Trait 来描述应用如何被从外界访问，以及一个 Autoscale Trait 来描述应用如何根据 CPU 使用量进行自动的水平扩容。</p></li></ul><p>而正是基于这种模块化的设计，这个 Appfile 本身是高度可扩展的。当任何一个新的 Workload Type 或者 Trait 被安装到平台后，用户就可以立刻在 Appfile 里声明使用这个新增的能力。举个例子，比如后面平台团队新开发了一个用来配置应用监控属性的运维侧能力，叫做 Metrics。那么只需要举手之捞，用户就可以立刻使用 $ vela show metrics 命令查看这个新增能力的详情，并且在 Appfile 中使用它，如下所示：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">metrices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/metrics&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">scheme</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这种简单友好、又高度敏捷的使用体验，正是 KubeVela 在最终用户侧提供的主要体感。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3）vela-up-命令"></a>3）Vela Up 命令<a class="hash-link" href="#3）vela-up-命令" title="Direct link to heading">#</a></h4><p>前面提到，一旦 Appfile 准备好，开发者只需要一句 vela up 命令就可以把整个应用连同它的运维特征部署到 Kubernetes 中。部署成功后，你可以使用 vela status 来查看整个应用的详情，包括如何访问这个应用。</p><p><img src="https://tvax2.sinaimg.cn/large/ad5fbf65gy1glf9pyhr42j20la0kiafn.jpg"></p><p>通过 KubeVela 部署的应用会被自动设置好访问 URL（以及不同版本对应的不同 URL），并且会由 cert-manager 生成好证书。与此同时，KubeVela 还提供了一系列辅助命令（比如：vela logs 和 vela exec）来帮助你在无需成为 Kubernetes 专家的情况下更好地管理和调试你的应用。如果你对上述由 KubeVela 带来的开发者体验感兴趣的话，欢迎前往 KubeVela 项目的用户使用文档来了解更多。</p><p>而接下来，我们要切换一下视角，感受一下平台团队眼中的 KubeVela 又是什么样子的。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-平台工程师眼中的-kubevela"></a>2. 平台工程师眼中的 KubeVela<a class="hash-link" href="#2-平台工程师眼中的-kubevela" title="Direct link to heading">#</a></h3><p>实际上，前面介绍到的所有开发者侧体验，都离不开 KubeVela 在平台侧进行的各种创新性设计与实现。也正是这些设计的存在，才使得 KubeVela 不是一个简单的 PaaS 或者 Serverless，<strong>而是一个可以由平台工程师扩展成任意垂直系统的云原生平台内核</strong>。</p><p>具体来说，KubeVela 为平台工程师提供了三大核心能力，使得基于 Kubernetes 构建上述面向用户的云原生平台从“阳春白雪”变成了“小菜一碟”：</p><p><strong>第一：以应用为中心</strong>。在 Appfile 背后，其实就是“应用”这个概念，它是基于 OAM 模型实现的。通过这样的方式，KubeVela 让“应用”这个概念成为了整个平台对用户暴露的核心 API。KubeVela 中的所有能力，都是围绕着“应用”展开的。这正是为何基于 KubeVela 扩展和构建出来的平台，天然是用户友好的：对于一个开发者来说，他只关心“应用”，而不是容器或者 Kubernetes；而 KubeVela 会确保构建整个平台的过程，也只与应用层的需求有关。</p><p><strong>第二：Kubernetes 原生的高可扩展性</strong>。在前面我们已经提到过，Appfile 是一个由 Workload Type 和 Trait 组成的、完全模块化的对象。而 OAM 模型的一个特点，就是任意一个 Kubernetes API 资源，都可以直接基于 Kubernetes 的 CRD 发现机制注册为一个 Workload Type 或者 Trait。这种可扩展性，使得 KubeVela 并不需要设计任何“插件系统”：<strong>KubeVela 里的每一个能力，都是插件，而整个 Kubernetes 社区，就是 KubeVela 原生的插件中心</strong>。</p><p><strong>第三：简单友好但高度可扩展的用户侧抽象体系</strong>。在了解了 Appfile 之后，你可能已经对这个对象的实现方式产生了好奇。实际上，KubeVela 中并不是简单的实现了一个 Appfile。在平台层，KubeVela 在 OAM 模型层实现中集成了CUELang 这种简洁强大的模板语言，从而为平台工程师基于 Kubernetes API 对象定义用户侧抽象（即：“最后一公里”抽象）提供了一个标准、通用的配置工具。更重要的是，平台工程师或者系统管理员，可以随时随地的每个能力对应的 CUE 模板进行修改，这些修改一旦提交到 Kubernetes，用户在 Appfile 里就可以立刻使用到新的抽象，不需要重新部署或者安装 KubeVela。</p><p>在具体实现层，KubeVela 是基于 OAM Kubernetes Runtime 构建的，同时采用 KEDA ，Flagger，Prometheus 等生态项目作为 Trait 的背后的依赖。当然，这些依赖只是 KubeVela 的选型，你可以随时为 KubeVela 定制和安装你喜欢的任何能力作为 Workload Type 或者 Trait。综合以上讲解，KubeVela 项目的整体架构由<strong>用户界面层，模型层，和能力管理层</strong>三部分组成，如下所示：</p><p><img src="https://tva2.sinaimg.cn/large/ad5fbf65gy1glf9sktkdxj20q00dsacl.jpg"></p><p>有了 KubeVela，平台工程师终于拥有了一个可以方便快捷地将任何一个 Kubernetes 社区能力封装抽象成一个面向用户的上层平台特性的强大工具。而作为这个平台的最终用户，用户们只需要学习这些上层抽象，在一个配置文件中描述应用，就可以一键交付出去。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-kubevela-vs-经典-paas"></a>3. KubeVela VS 经典 PaaS<a class="hash-link" href="#3-kubevela-vs-经典-paas" title="Direct link to heading">#</a></h3><p>很多人可能会问，KubeVela 跟经典 PaaS 的主要区别和联系是什么呢？</p><p>事实上，大多数经典 PaaS 都能提供完整的应用生命周期管理功能，同时也非常关注提供简单友好的用户体验，提升研发效能。在这些点上，KubeVela 跟经典 PaaS 的目标，是非常一致的。</p><p>但另一方面，经典 PaaS 往往是不可扩展的（比如 Rancher 的 Rio 项目），或者会引入属于自己的插件生态（哪怕这个 PaaS 是完全基于 Kubernetes 构建的），以此来确保平台本身的用户体验和能力的可控制性（比如 Cloud Foundry 或者 Heroku 的<a href="https://elements.heroku.com/addons" target="_blank" rel="noopener noreferrer">插件中心</a>）。</p><p>相比之下，KubeVela 的设计是完全不同的。KubeVela 的目标，从一开始就是利用整个 Kubernetes 社区作为自己的“插件中心”，并且“故意”把它的每一个内置能力都设计成是独立的、可插拔的插件。这种高度可扩展的模型，背后其实有着精密的设计与实现。比如，KubeVela 如何确保某个完全独立的 Trait 一定能够绑定于某种 Workload Type？如何检查这些相互独立的 Trait 是否冲突？这些挑战，正是 Open Application Model（OAM）作为 KubeVela 模型层的起到的关键作用，一言以蔽之：OAM 是一个高度可扩展的应用定义与能力管理模型。</p><p>KubeVela 和 OAM 社区欢迎大家设计和制作任何 Workload Type 和 Trait 的定义文件。只要把它们存放在 GitHub 上，全世界任何一个 KubeVela 用户就都可以在自己的 Appfile 里使用你所设计的能力。具体的方式，请参考 <code>$ vela cap</code> （即：插件能力管理命令）的<a href="https://kubevela.io/#/en/developers/cap-center" target="_blank" rel="noopener noreferrer">使用文档</a>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="了解更多"></a>了解更多<a class="hash-link" href="#了解更多" title="Direct link to heading">#</a></h2><p>KubeVela 项目是 OAM 社区的官方项目，旨在取代原先的 Rudr 项目。不过，与 <a href="https://github.com/oam-dev/rudr" target="_blank" rel="noopener noreferrer">Rudr</a> 主要作为“参考实现”的定位不同，KubeVela 既是一个端到端、面向全量场景的 OAM Kubernetes 完整实现，同时也是阿里云 EDAS 服务和内部多个核心 PaaS/Serverless 生产系统底层的核心组件。 此外，KubeVela 中 Apppfile 的设计，也是 OAM 社区在 OAM 规范中即将引入的“面向用户侧对象”的核心部分。</p><p>如果你想要更好的了解 KubeVela 项目，欢迎前往其官方网站上<a href="https://kubevela.io/" target="_blank" rel="noopener noreferrer">学习具体的示例和手册</a>。以下也是一些非常好的学习内容和方式：</p><ul><li>前往学习 <a href="https://kubevela.io/#/en/quick-start" target="_blank" rel="noopener noreferrer">KubeVela Quick Start（新手教程）</a>，一步步了解 KubeVela 的使用方法。</li><li>前往 OAM 社区深入交流和反馈。中文：钉钉群 23310022，英文：<a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer">Gitter</a> 和 <a href="https://cloud-native.slack.com/archives/C01BLQ3HTJA" target="_blank" rel="noopener noreferrer">CNCF Slack</a>。</li><li>尝试为 <a href="https://kubevela.io/#/en/platform-engineers/trait" target="_blank" rel="noopener noreferrer">KubeVela 添加来自开源社区的插件能力</a>。此外，如果你有任何关于扩展 KubeVela 的奇妙想法，比如，基于 KubeVela 开发一个自己的云原生数据库 PaaS 或者 AI PaaS，欢迎前往 OAM 社区通过 Issue 来进行讨论。</li><li>为 KubeVela 贡献代码. KubeVela 项目是一个诞生自云原生社区的开源项目（感谢来自 8 家不同公司的<a href="https://github.com/oam-dev/kubevela/blob/bbb2c527d96d3e1a0694e2f49b3d1d1168e72c53/OWNERS_ALIASES#L35" target="_blank" rel="noopener noreferrer">初始贡献者</a>，并特别鸣谢 KubeVela 网站的发起者 <a href="https://github.com/sunny0826" target="_blank" rel="noopener noreferrer">guoxudong</a>）。 </li></ul><p><strong>KubeVela 项目的维护者会在项目稳定后，即将整个项目所有权捐赠给中立开源基金会。</strong></p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/zh/blog/tags/kubevela">kubevela</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">文档</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/docs/quick-start">快速开始</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/case-studies/jenkins-cicd">最佳实践</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/platform-engineers/oam/oam-model">管理员手册</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">社区</h4><ul class="footer__items"><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #kubevela channel )</a></li><li class="footer__item"><a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/">钉钉 (23310022)</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">更多</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog">博客</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© KubeVela Authors 2021 | Documentation Distributed under <a herf="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a> </strong> <strong>| Powered by <a href="https://www.netlify.com">Netlify</a></strong>
        <br>
      </div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.013ba7d0.js"></script>
<script src="/zh/assets/js/main.5874ed7f.js"></script>
</body>
</html>